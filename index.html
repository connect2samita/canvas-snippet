<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Konva Drawing</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/konva@4.0.16/konva.min.js"></script>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <a class="navbar-brand" href="index.html">
        <img src="icon/creative.svg" height="30px">
      </a>
      <!-- <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button> -->

      <!-- <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Github <span class="sr-only">(current)</span></a>
          </li>
        </ul>
      </div> -->
    </nav>

    <div class="canvas-container">
      <div class="col-md-3 p-0 br-1">
          <div id="accordion-canvas" class="canvas-accordion">
            <!-- Shapes -->
            <div class="card">
              <div class="card-header" id="headingOne">
                <h2 class="mb-0">
                  <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseShapes" aria-expanded="true" aria-controls="collapseShapes">
                    Shapes
                  </button>
                </h2>
              </div>
              <div id="collapseShapes" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion-canvas">
                <div class="card-body">
                    <ul class="canvas-icons">
                        <li onclick="drawcircle()"><img src="icon/circle.svg"/></li>
                        <li onclick="drawrectangle()"><img src="icon/rectangle.svg"/></li>
                        <li onclick="drawsquare()"><img src="icon/square.svg"/></li>
                        <li onclick="drawtriangle()"><img src="icon/triangle.svg"/></li>
                        <li onclick="drawline()"><img src="icon/line.svg"/></li>
                        <li onclick="drawarrow()"><img src="icon/arrow.svg"/></li>
                        <li onclick="drawstar()"><img src="icon/star.svg"/></li>
                      </ul>
                </div>
              </div>
            </div>
            <!-- Properties -->
            <div class="card">
              <div class="card-header" id="headingTwo">
                <h2 class="mb-0">
                  <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseProperties" aria-expanded="false" aria-controls="collapseProperties">
                    Properties
                  </button>
                </h2>
              </div>
              <div id="collapseProperties" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion-canvas">
                <div class="card-body">
                  <form action="#">
                    <div class="form-group row">
                      <label for="itemName" class="col-sm-6 col-form-label">Item Name</label>
                      <div class="col-sm-6">
                        <input type="text" name="itemName" class="form-control" id="itemName" value="">
                      </div>
                    </div>
                    <div class="form-group row">
                      <label for="backgroundColor" class="col-sm-6 col-form-label">Background Color</label>
                      <div class="col-sm-6">
                        <input type="color" name="backgroundColor" class="form-control" id="backgroundColor" value="#ffffff">
                      </div>
                    </div>
                    <div class="form-group row">
                        <label for="strokeColor" class="col-sm-6 col-form-label">Stroke Color</label>
                        <div class="col-sm-6">
                          <input type="color" name="strokeColor" class="form-control" id="strokeColor" value="#000000">
                        </div>
                      </div>
                    <div class="form-group row">
                      <label for="strokeWidth" class="col-sm-6 col-form-label">Stroke Width</label>
                      <div class="col-sm-6">
                        <input type="range" name="strokeWidth" class="custom-range" min="0" max="5" id="strokeWidth" value="2">
                      </div>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="deleteItem()">Delete</button>
                  </form>
                </div>
              </div>
            </div>
            <!-- Connections -->
            <div class="card">
              <div class="card-header" id="headingThree">
                <h2 class="mb-0">
                  <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                    Connections
                  </button>
                </h2>
              </div>
              <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordion-canvas">
                <div class="card-body">
                    <ul class="list-group" id="canvas-connections"></ul>
                </div>
              </div>
            </div>
            <!-- SVGs -->
            <div class="card">
              <div class="card-header" id="headingFour">
                <h2 class="mb-0">
                  <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseSVGs" aria-expanded="true" aria-controls="collapseSVGs">
                    SVGs
                  </button>
                </h2>
              </div>
              <div id="collapseSVGs" class="collapse" aria-labelledby="headingFour" data-parent="#accordion-canvas">
                <div class="card-body">
                    <ul class="canvas-icons">
                      <li onclick="drawsvg('001-manufacture.svg')"><img src="svg/001-manufacture.svg"/></li>
                      <li onclick="drawsvg('002-factory.svg')"><img src="svg/002-factory.svg"/></li>
                      <li onclick="drawsvg('003-conveyor.svg')"><img src="svg/003-conveyor.svg"/></li>
                      <li onclick="drawsvg('004-robot-arm.svg')"><img src="svg/004-robot-arm.svg"/></li>
                      <li onclick="drawsvg('005-conveyor-1.svg')"><img src="svg/005-conveyor-1.svg"/></li>
                      <li onclick="drawsvg('007-excavator.svg')"><img src="svg/007-excavator.svg"/></li>
                      <li onclick="drawsvg('008-heavy-machinery.svg')"><img src="svg/008-heavy-machinery.svg"/></li>
                      <li onclick="drawsvg('009-excavator-1.svg')"><img src="svg/009-excavator-1.svg"/></li>
                      <li onclick="drawsvg('010-building-crane.svg')"><img src="svg/010-building-crane.svg"/></li>
                      <li onclick="drawsvg('011-machinery.svg')"><img src="svg/011-machinery.svg"/></li>
                      <li onclick="drawsvg('016-conveyor-3.svg')"><img src="svg/016-conveyor-3.svg"/></li>
                    </ul>
                </div>
              </div>
            </div>
          </div>
      </div>
      <div class="col-md-9 p-0">
        <div id="container" class="canvas-area"></div>
      </div>

      <div class="modal" id="connectionModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Modal title</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form>
                <select name="item-list" id="item-list">
                  <option value="">Select an item</option>
                </select>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="createConnection()">Save changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      var width = $('#container').width();
      var height = $('#container').height();

      var items = []
      var selectedItem
      var connections = []
      var openConnection

      var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height
      });

      var layer = new Konva.Layer();
      var tooltipLayer = new Konva.Layer();
      stage.add(layer);

      var tooltip = new Konva.Text({
        text: '',
        fontFamily: 'Calibri',
        fontSize: 12,
        padding: 5,
        textFill: 'white',
        fill: 'black',
        alpha: 0.75,
        visible: false
      });

      tooltipLayer.add(tooltip);
      stage.add(tooltipLayer);

      // function to generate a list of "targets" (circles)
      function generateTargets() {
        var number = 10;
        var result = [];
        while (result.length < number) {
          result.push({
            id: 'target-' + result.length,
            x: stage.width() * Math.random(),
            y: stage.height() * Math.random()
          });
        }
        return result;
      }

      var targets = generateTargets();

      // function to generate arrows between targets
      function generateConnectors() {
        var number = 10;
        var result = [];
        while (result.length < number) {
          var from = 'target-' + Math.floor(Math.random() * targets.length);
          var to = 'target-' + Math.floor(Math.random() * targets.length);
          if (from === to) {
            continue;
          }
          result.push({
            id: 'connector-' + result.length,
            from: from,
            to: to
          });
        }
        return result;
      }

      function getConnectorPoints(from, to) {
        const dx = to.x - from.x;
        const dy = to.y - from.y;
        let angle = Math.atan2(-dy, dx);

        const radius = 50;

        return [
          from.x + -radius * Math.cos(angle + Math.PI),
          from.y + radius * Math.sin(angle + Math.PI),
          to.x + -radius * Math.cos(angle),
          to.y + radius * Math.sin(angle)
        ];
      }

      var connectors = generateConnectors();
      console.log(targets)
      console.log(connectors)

      // update all objects on the canvas from the state of the app
      function updateObjects() {
        connections.forEach(connect => {
          var line = new Konva.Arrow({
            stroke: '#000000',
            id: connect.id,
            fill: '#000000',
            draggable: true,
            name: "transform",
          });
          layer.add(line);
        });
        connections.forEach(connect => {
          var line = layer.findOne('#' + connect.id);
          var fromNode = layer.findOne('#' + connect.from);
          var toNode = layer.findOne('#' + connect.to);

          const points = getConnectorPoints(
            fromNode.position(),
            toNode.position()
          );
          line.points(points);
        });
        layer.batchDraw();
      }

      // generate nodes for the app
      // connectors.forEach(connect => {
      //   var line = new Konva.Arrow({
      //     stroke: '#000000',
      //     id: connect.id,
      //     fill: '#000000'
      //   });
      //   layer.add(line);
      // });

      // targets.forEach(target => {
      //   var node = new Konva.Circle({
      //     id: target.id,
      //     fill: Konva.Util.getRandomColor(),
      //     radius: 20 + Math.random() * 20,
      //     shadowBlur: 10,
      //     draggable: true
      //   });
      //   layer.add(node);

      //   node.on('dragmove', () => {
      //     // mutate the state
      //     target.x = node.x();
      //     target.y = node.y();

      //     // update nodes from the new state
      //     updateObjects();
      //   });
      // });

      function drawsvg(name) {
        let path = "svg/" + name
        Konva.Image.fromURL(path, (image) => {
          image.setAttrs({
            x: stage.width() / 2,
            y: stage.height() / 2,
            width: 50,
            height: 50,
            draggable: true,
            name: "transform",
            tooltip: name,
            id: `target-${items.length}`
          });

          items.push(image);

          layer.add(image);
          layer.draw();

          addItem(image);

          image.on('mousemove', function(e) {
            var mousePos = stage.getPointerPosition();
            tooltip.position({
              x: mousePos.x + 5,
              y: mousePos.y + 5
            });
            tooltip.text(e.target.attrs.tooltip);
            tooltip.show();
            tooltipLayer.batchDraw();
          });

          image.on('mouseout', function() {
            tooltip.hide();
            tooltipLayer.draw();
          });
        })
      }

      function drawcircle() {
        var cir1 = new Konva.Circle({
          x: stage.width() / 2,
          y: stage.height() / 2,
          radius: 25,
          fill: '#FFFFFF',
          stroke: '#000000',
          strokeWidth: 2,
          draggable: true,
          name: "transform",
          tooltip: "Circle",
          id: `target-${items.length}`
        });

        items.push(cir1);

        layer.add(cir1);
        layer.draw();

        addItem(cir1);

        cir1.on('mousemove', function(e) {
          var mousePos = stage.getPointerPosition();
          tooltip.position({
            x: mousePos.x + 5,
            y: mousePos.y + 5
          });
          tooltip.text(e.target.attrs.tooltip);
          tooltip.show();
          tooltipLayer.batchDraw();
        });

        cir1.on('mouseout', function() {
          tooltip.hide();
          tooltipLayer.draw();
        });
      }

      function drawrectangle() {
        let rect1 = new Konva.Rect({
          x: stage.width() / 2 - 50,
          y: stage.height() / 2 - 25,
          width: 100,
          height: 50,
          fill: '#FFFFFF',
          stroke: '#000000',
          strokeWidth: 2,
          draggable: true,
          name: "transform",
          tooltip: "Rectangle",
          id: `target-${items.length}`
        });

        items.push(rect1);

        layer.add(rect1);
        layer.draw();

        addItem(rect1);
      }

      function drawsquare() {
        let sq1 = new Konva.Rect({
          x: stage.width() / 2 - 50,
          y: stage.height() / 2 - 25,
          width: 50,
          height: 50,
          fill: '#FFFFFF',
          stroke: '#000000',
          strokeWidth: 2,
          draggable: true,
          name: "transform",
          tooltip: "Square",
          id: `target-${items.length}`
        });

        items.push(sq1);

        layer.add(sq1);
        layer.draw();

        addItem(sq1);
      }

      function drawtriangle() {
        var tri1 = new Konva.RegularPolygon({
          x: stage.width() / 2,
          y: stage.height() / 2,
          sides: 3,
          radius: 35,
          fill: '#FFFFFF',
          stroke: '#000000',
          strokeWidth: 2,
          draggable: true,
          name: "transform",
          tooltip: "Triangle",
          id: `target-${items.length}`
        });

        items.push(tri1);

        layer.add(tri1);
        layer.draw();

        addItem(tri1);
      }

      function drawline() {
        var lin1 = new Konva.Line({
          x: stage.width() / 2,
          y: stage.height() / 2,
          points: [0, stage.height() / 8, stage.width() / 8, stage.height() / 8],
          stroke: '#000000',
          strokeWidth: 2,
          lineCap: "round",
          draggable: true,
          name: "transform",
          id: `target-${items.length}`
        });

        layer.add(lin1);
        layer.draw();
      }

      function drawarrow() {
        var arr1 = new Konva.Arrow({
          x: stage.width() / 2,
          y: stage.height() / 2,
          points: [0, stage.height() / 8, stage.width() / 8, stage.height() / 8],
          pointerLength: 10,
          pointerWidth: 10,
          fill: '#000000',
          stroke: '#000000',
          strokeWidth: 2,
          draggable: true,
          name: "transform",
          id: `target-${items.length}`
        });

        layer.add(arr1);
        layer.draw();
      }

      function drawstar() {
        var str1 = new Konva.Star({
          x: stage.width() / 2,
          y: stage.height() / 2,
          numPoints: 5,
          innerRadius: 12.5,
          outerRadius: 25,
          fill: '#FFFFFF',
          stroke: '#000000',
          strokeWidth: 2,
          draggable: true,
          name: "transform",
          tooltip: "Star",
          id: `target-${items.length}`
        });

        items.push(str1);

        layer.add(str1);
        layer.draw();

        addItem(str1);
      }

      function addItem(item) {
        var li = `<li class="list-group-item d-flex justify-content-between align-items-center" data-toggle="modal" data-target="#connectionModal" onclick="connectionSettings()" data-id="${item.attrs.id}">
                    ${item.attrs.tooltip} ${item._id}
                    <span class="badge badge-primary badge-pill">${item.children.length}</span>
                  </li>`
        $('#canvas-connections').append(li)

        var option = `<option value="${item.attrs.id}">${item.attrs.tooltip} ${item._id}</option>`
        $('#item-list').append(option)

        transformItem(item)
        $('#collapseProperties').collapse('toggle')

        console.log(item)
      }

      function deleteItem() {
        selectedItem.destroy();
        let list = $(`#canvas-connections li[data-id=${selectedItem.attrs.id}]`);
        $(list[0]).remove();
        $(`#item-list option[value=${selectedItem.attrs.id}]`).remove();
        // TODO: Remove connection of the item
        selectedItem = {}
        stage.find('Transformer').destroy();
        layer.draw();
      }

      function transformItem(item) {
        // remove old transformers
        // TODO: we can skip it if current rect is already selected
        stage.find('Transformer').destroy();

        var transform = new Konva.Transformer();
        layer.add(transform);
        transform.attachTo(item);
        layer.draw();

        selectedItem = item;
        $('form input[name=itemName]').val(selectedItem.attrs.tooltip)
        $('form input[name=backgroundColor]').val(selectedItem.attrs.fill)
        $('form input[name=strokeColor]').val(selectedItem.attrs.stroke)
        $('form input[name=strokeWidth]').val(selectedItem.attrs.strokeWidth)
      }

      stage.on('click tap', function(evt) {
        // if click on empty area - remove all transformers
        if (evt.target === stage) {
          stage.find('Transformer').destroy();
          layer.draw();
          return;
        }
        // do nothing if clicked NOT on our rectangles
        if (!evt.target.hasName('transform')) {
          return;
        }

        // create new transformer
        transformItem(evt.target);
      });

      layer.on('click', function(evt) {
        selectedItem = evt.target;
        $('form input[name=itemName]').val(selectedItem.attrs.tooltip)
        $('form input[name=backgroundColor]').val(selectedItem.attrs.fill)
        $('form input[name=strokeColor]').val(selectedItem.attrs.stroke)
        $('form input[name=strokeWidth]').val(selectedItem.attrs.strokeWidth)
      });

      $('form input[name=itemName]').on('change', (evt) => {
        selectedItem.attrs.tooltip = evt.target.value
        selectedItem.draw()
      })
      $('form input[name=backgroundColor]').on('change', (evt) => {
        selectedItem.fill(evt.target.value)
        selectedItem.draw()
      })
      $('form input[name=strokeColor]').on('change', (evt) => {
        selectedItem.stroke(evt.target.value)
        selectedItem.draw()
      })
      $('form input[name=strokeWidth]').on('change', (evt) => {
        selectedItem.strokeWidth(evt.target.value)
        selectedItem.draw()
      })

      function connectionSettings() {
        let id = $(event.target).attr('data-id')
        let obj = items.find(ele => {
          return ele.attrs.id === id
        });

        $('.modal-title').text(obj.attrs.tooltip)
        openConnection = obj
      }

      function createConnection() {
        let id = $('#item-list').val()
        var seletedConnection = items.find(ele => {
          return ele.attrs.id === id
        });

        if (openConnection._id === seletedConnection._id) {
          alert("Cannot connect same items")
        } else {
          var obj = {
            id : `connection-${connections.length}`,
            from : `${openConnection.attrs.id}`,
            to : `${seletedConnection.attrs.id}`
          }

          connections.push(obj)
        }
        updateObjects()
        $('#connectionModal').modal('toggle')
      }
    </script>
  </body>
</html>
